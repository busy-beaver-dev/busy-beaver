"""add key-vaue table store

Revision ID: 78514b173380
Revises: 312e762dfa85
Create Date: 2019-01-21 21:59:34.979693

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.orm import sessionmaker

from busy_beaver import twitter
from busy_beaver.retweeter import LAST_TWEET_KEY

# revision identifiers, used by Alembic.
revision = "78514b173380"
down_revision = "312e762dfa85"
branch_labels = None
depends_on = None


def upgrade():
    Session = sessionmaker()

    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "kv_store",
        sa.Column("key", sa.String(length=250), nullable=False),
        sa.Column("value", sa.LargeBinary(), nullable=False),
        sa.PrimaryKeyConstraint("key"),
    )
    # ### end Alembic commands ###
    bind = op.get_bind()
    session = Session(bind=bind)

    # initialize datastore with value of last tweet
    try:
        last_id = twitter.get_last_tweet_id()
    except Exception:  # NOT a fan, but it makes migration in prod easier
        last_id = 42
    q = f"INSERT INTO kv_store (key, value) VALUES ('{LAST_TWEET_KEY}', '{last_id}')"
    session.execute(q)


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table("kv_store")
    # ### end Alembic commands ###
