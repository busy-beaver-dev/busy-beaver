# misc
notifications:
  email: false
sudo: false

env:
  - PYTHONPATH=. DATABASE_URI="sqlite:///busy_beaver.db"

# python settings
language: python
sudo: required
dist: xenial
python:
  - "3.7"

# install packages
install:
  - pip install -r requirements_dev.txt

before_script:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker pull ${IMAGE_NAME}:latest || true

# run test
script:
  - alembic --config=./migrations/alembic.ini upgrade head
  - pytest --cov=./
  - flake8
  - docker build --pull --cache-from ${IMAGE_NAME}:latest --tag ${IMAGE_NAME} .

before_deploy:
  - docker tag ${IMAGE_NAME} ${IMAGE_NAME}:latest
  - docker tag ${IMAGE_NAME} ${IMAGE_NAME}:${git_sha}
deploy:
  provider: script
  script:
    - docker push ${IMAGE_NAME}:latest && docker push ${IMAGE_NAME}:${git_sha}
  on:
    branch: master
